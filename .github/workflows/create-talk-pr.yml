name: Add Talk on Issue Close

on:
  issues:
    types: [closed]

jobs:
  add-talk:
    if: contains(github.event.issue.labels.*.name, 'talk-proposal')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse issue and add talk
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body;
            
            function parseField(body, label) {
              const regex = new RegExp('### ' + label + '\\s*\\n\\s*([\\s\\S]*?)(?=\\n###|$)', 'i');
              const match = body.match(regex);
              if (match) {
                return match[1].trim();
              }
              return '';
            }
            
            function parseTags(body) {
              const tagsSection = parseField(body, 'Tags');
              const tags = [];
              const lines = tagsSection.split('\n');
              for (const line of lines) {
                if (line.includes('[X]') || line.includes('[x]')) {
                  const tag = line.replace(/- \[.\]\s*/, '').trim();
                  if (tag) tags.push(tag);
                }
              }
              return tags;
            }
            
            const title = parseField(body, 'Talk Title');
            const speakerName = parseField(body, 'Speaker Name');
            const speakerGithub = parseField(body, 'GitHub Username');
            const speakerLinkedin = parseField(body, 'LinkedIn Profile \\(optional\\)');
            const speakerBio = parseField(body, 'Speaker Bio \\(optional\\)');
            const abstract = parseField(body, 'Talk Abstract');
            const duration = parseField(body, 'Talk Duration');
            const level = parseField(body, 'Target Audience Level');
            const tags = parseTags(body);
            const prerequisites = parseField(body, 'Prerequisites \\(optional\\)');
            const additionalInfo = parseField(body, 'Additional Information \\(optional\\)');
            
            const slug = title.toLowerCase()
              .replace(/[^a-z0-9]+/g, '-')
              .replace(/^-|-$/g, '');
            
            const now = new Date();
            const year = now.getFullYear();
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            const month = monthNames[now.getMonth()];
            const date = now.toISOString().split('T')[0];
            
            const folderPath = 'content/talks/' + year + '/' + month;
            const filename = folderPath + '/' + slug + '.md';
            
            const tagsYaml = tags.length > 0 ? '\ntags:\n' + tags.map(t => '  - "' + t + '"').join('\n') : '';
            const bioYaml = speakerBio ? '\nbio: |\n  ' + speakerBio.split('\n').join('\n  ') : '';
            
            let content = '---\n';
            content += 'title: "' + title + '"\n';
            content += 'date: ' + date + '\n';
            content += 'speaker:\n';
            content += '  name: "' + speakerName + '"\n';
            content += '  github: "' + speakerGithub + '"\n';
            content += '  linkedin: "' + (speakerLinkedin || '') + '"' + bioYaml + '\n';
            content += 'duration: "' + duration + '"\n';
            content += 'level: "' + level + '"' + tagsYaml + '\n';
            content += 'issue: ' + issue.number + '\n';
            content += '---\n\n';
            content += '## Abstract\n\n';
            content += abstract + '\n\n';
            if (prerequisites) {
              content += '## Prerequisites\n\n' + prerequisites + '\n\n';
            }
            if (additionalInfo) {
              content += '## Additional Information\n\n' + additionalInfo + '\n\n';
            }
            content += '---\n\n';
            content += '*Added via [Issue #' + issue.number + '](' + issue.html_url + ')*\n';

            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: filename,
              message: 'Add talk: ' + title + ' by ' + speakerName,
              content: Buffer.from(content).toString('base64'),
              branch: 'main'
            });
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: '‚úÖ Talk added to repository!\n\nüìÅ File: `' + filename + '`\n\nThank you for your contribution to Kubeflow Commons Hub! üéâ'
            });
            
            console.log('Added talk file: ' + filename);
